<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta http-equiv="Content-Security-Policy" content="default-src 'self'; script-src 'self'; media-src 'self' mediastream:; img-src 'self' data: blob:">
  <title>Chatty Cathy - Classroom Noise Monitor</title>
  <link rel="stylesheet" href="styles.css">
  <script src="../node_modules/d3/dist/d3.min.js"></script>
</head>
<body>
  <!-- Main Screen -->
  <div id="mainScreen" class="screen active">
    <button id="settingsBtn" class="settings-gear" title="Settings">
      <svg viewBox="0 0 24 24" fill="currentColor">
        <path d="M12 15.5A3.5 3.5 0 0 1 8.5 12A3.5 3.5 0 0 1 12 8.5a3.5 3.5 0 0 1 3.5 3.5a3.5 3.5 0 0 1-3.5 3.5m7.43-2.53c.04-.32.07-.64.07-.97c0-.33-.03-.66-.07-1l2.11-1.63c.19-.15.24-.42.12-.64l-2-3.46c-.12-.22-.39-.31-.61-.22l-2.49 1c-.52-.39-1.06-.73-1.69-.98l-.37-2.65A.506.506 0 0 0 14 2h-4c-.25 0-.46.18-.5.42l-.37 2.65c-.63.25-1.17.59-1.69.98l-2.49-1c-.22-.09-.49 0-.61.22l-2 3.46c-.13.22-.07.49.12.64L4.57 11c-.04.34-.07.67-.07 1c0 .33.03.65.07.97l-2.11 1.66c-.19.15-.25.42-.12.64l2 3.46c.12.22.39.3.61.22l2.49-1.01c.52.4 1.06.74 1.69.99l.37 2.65c.04.24.25.42.5.42h4c.25 0 .46-.18.5-.42l.37-2.65c.63-.26 1.17-.59 1.69-.99l2.49 1.01c.22.08.49 0 .61-.22l2-3.46c.12-.22.07-.49-.12-.64l-2.11-1.66Z"/>
      </svg>
    </button>
    <div class="volume-meter">
      <div class="meter-container" id="meterContainer">
        <div class="meter-fill" id="meterFill"></div>
        <div class="meter-segments" id="meterSegments"></div>
      </div>
      <div class="meter-label">VOLUME</div>
    </div>
    <div class="main-content">
      <header class="top-controls">
        <div class="title-section">
          <h1>Chatty Cathy</h1>
          <p>Classroom Noise Monitor</p>
        </div>
        <div class="controls-section">
          <div class="class-selector">
            <label for="classSelect">Class:</label>
            <select id="classSelect">
              <option value="">-- Select Class --</option>
            </select>
          </div>
          <div class="mic-selector">
            <label for="micSelect">Microphone:</label>
            <select id="micSelect"></select>
          </div>
          <button id="startBtn" class="start-button">Start Monitoring</button>
        </div>
      </header>
      <div class="teacher-display" id="teacherDisplay">
        <div class="teacher-placeholder">
          <p>Start monitoring to see the teacher's reaction!</p>
        </div>
      </div>
    </div>
  </div>

  <!-- Settings Screen -->
  <div id="settingsScreen" class="screen">
    <button id="backBtn" class="back-button" title="Back">
      <svg viewBox="0 0 24 24" fill="currentColor">
        <path d="M20 11H7.83l5.59-5.59L12 4l-8 8l8 8l1.41-1.41L7.83 13H20v-2z"/>
      </svg>
      Back
    </button>
    <div class="settings-container">
      <nav class="settings-sidebar">
        <button class="sidebar-btn active" data-panel="classes">Classes</button>
        <button class="sidebar-btn" data-panel="levels">Levels</button>
        <button class="sidebar-btn" data-panel="statistics">Statistics</button>
      </nav>
      <div class="settings-content">
        <div id="classesPanel" class="settings-panel active">
          <h2>Classes</h2>
          <p class="panel-description">Add and manage your classroom classes for tracking noise levels.</p>

          <div class="class-form">
            <input type="text" id="newClassName" placeholder="Enter class name (e.g., Period 1 - Math)">
            <button id="addClassBtn" class="add-btn">Add Class</button>
          </div>

          <div class="classes-list" id="classesList"></div>
        </div>
        <div id="levelsPanel" class="settings-panel">
          <h2>Levels</h2>
          <p class="levels-description">Click on the bar to add a threshold. Drag stops to adjust. Right-click to remove.</p>

          <div class="threshold-editor">
            <div class="threshold-bar" id="thresholdBar">
              <div class="threshold-gradient"></div>
              <div class="threshold-stops" id="thresholdStops"></div>
            </div>
            <div class="threshold-labels">
              <span>0%</span>
              <span>25%</span>
              <span>50%</span>
              <span>75%</span>
              <span>100%</span>
            </div>
          </div>

          <div class="stop-editor" id="stopEditor" style="display: none;">
            <h3>Edit Threshold: <span id="stopPercentage">0</span>%</h3>
            <div class="stop-image-section">
              <div class="stop-image-preview" id="stopImagePreview">
                <span>No image</span>
              </div>
              <div class="stop-image-controls">
                <label class="upload-btn">
                  Choose Image
                  <input type="file" id="stopImageInput" accept="image/*" hidden>
                </label>
                <button id="removeImageBtn" class="remove-btn">Remove Image</button>
                <div class="fit-mode-toggle">
                  <button id="fitCoverBtn" class="fit-mode-btn active" title="Fill entire area (may crop)">Fill</button>
                  <button id="fitContainBtn" class="fit-mode-btn" title="Fit entire image (may show background)">Fit</button>
                </div>
                <span class="position-hint">Drag image to reposition</span>
              </div>
            </div>
            <div class="stop-label-section">
              <label for="stopLabelInput">Label:</label>
              <input type="text" id="stopLabelInput" placeholder="e.g., Quiet, Loud, etc.">
            </div>
          </div>

          <div class="levels-list" id="levelsList"></div>
        </div>
        <div id="statisticsPanel" class="settings-panel">
          <h2>Statistics</h2>
          <p class="panel-description">View noise level trends over time for your classes.</p>

          <div class="stats-controls">
            <div class="stats-class-selector">
              <label for="statsClassSelect">Class:</label>
              <select id="statsClassSelect">
                <option value="">-- Select Class --</option>
              </select>
            </div>
            <div class="stats-time-range">
              <label for="statsTimeRange">Time Range:</label>
              <select id="statsTimeRange">
                <option value="hour">Last Hour</option>
                <option value="day" selected>Last 24 Hours</option>
                <option value="week">Last Week</option>
                <option value="month">Last Month</option>
              </select>
            </div>
            <div class="stats-explanations-toggle">
              <button id="toggleExplanations" class="toggle-btn" title="Toggle explanations">
                <span class="toggle-icon">ℹ️</span>
                <span class="toggle-text">Show Explanations</span>
              </button>
            </div>
          </div>

          <!-- All-Time Records Card -->
          <div class="stats-all-time-card" id="statsAllTimeCard">
            <h3>All-Time Records</h3>
            <div class="all-time-stats-grid">
              <div class="all-time-stat">
                <span class="stat-label">Longest Time at Highest</span>
                <span class="stat-value" id="statsAllTimePeak">--</span>
                <span class="stat-date" id="statsAllTimePeakDate">--</span>
                <div class="stat-explanation explanation-hidden">
                  The longest continuous period where noise levels stayed at or near the highest recorded volume. This shows how long the class remained at peak noise levels.
                </div>
              </div>
              <div class="all-time-stat">
                <span class="stat-label">Longest Time at Lowest</span>
                <span class="stat-value" id="statsAllTimeMin">--</span>
                <span class="stat-date" id="statsAllTimeMinDate">--</span>
                <div class="stat-explanation explanation-hidden">
                  The longest continuous period where noise levels stayed at or near the lowest recorded volume. This shows how long the class remained quietest.
                </div>
              </div>
              <div class="all-time-stat">
                <span class="stat-label">All-Time Average</span>
                <span class="stat-value" id="statsAllTimeAvg">--</span>
                <div class="stat-explanation explanation-hidden">
                  The average noise level across all recorded samples for this class. This gives you the overall "typical" volume level.
                </div>
                <div class="volatility-formula explanation-hidden">
                  <div class="formula-container">
                    <span class="formula-main">μ =</span>
                    <span class="formula-fraction">
                      <span class="formula-numerator">Σx</span>
                      <span class="formula-divider"></span>
                      <span class="formula-denominator">n</span>
                    </span>
                  </div>
                  <div class="formula-variables">
                    <div class="variable-item">
                      <span class="variable-symbol">μ</span>
                      <span class="variable-label">= Mean (average) noise level</span>
                    </div>
                    <div class="variable-item">
                      <span class="variable-symbol">x</span>
                      <span class="variable-label">= Each noise level measurement</span>
                    </div>
                    <div class="variable-item">
                      <span class="variable-symbol">n</span>
                      <span class="variable-label">= Total number of samples</span>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <!-- Time-Based Statistics Section -->
          <div class="stats-time-based" id="statsTimeBased">
            <h3>Session-Based Time Analysis</h3>
            <div class="time-stats-grid">
              <div class="time-stat-card">
                <span class="time-label">Average Quietest Time</span>
                <span class="time-value" id="statsQuietestHour">--</span>
                <span class="time-avg" id="statsQuietestHourAvg">--</span>
                <div class="stat-explanation explanation-hidden">
                  The average time of day (across all monitoring sessions) when the class is typically quietest. Useful for identifying when students are most focused.
                </div>
                <div class="volatility-formula explanation-hidden">
                  <div class="formula-container">
                    <span class="formula-main">avg_time = mean(time₁, time₂, ..., timeₙ)</span>
                  </div>
                </div>
              </div>
              <div class="time-stat-card">
                <span class="time-label">Average Loudest Time</span>
                <span class="time-value" id="statsLoudestHour">--</span>
                <span class="time-avg" id="statsLoudestHourAvg">--</span>
                <div class="stat-explanation explanation-hidden">
                  The average time of day (across all monitoring sessions) when the class is typically loudest. Helps identify when noise levels peak.
                </div>
                <div class="volatility-formula explanation-hidden">
                  <div class="formula-container">
                    <span class="formula-main">avg_time = mean(time₁, time₂, ..., timeₙ)</span>
                  </div>
                </div>
              </div>
              <div class="time-stat-card">
                <span class="time-label">Session Pattern</span>
                <span class="time-value" id="statsQuietestDay">--</span>
                <span class="time-avg" id="statsQuietestDayAvg">--</span>
                <div class="stat-explanation explanation-hidden">
                  The pattern of days when monitoring sessions occur (e.g., MWF for Monday/Wednesday/Friday, TTh for Tuesday/Thursday). Shows your class schedule.
                </div>
              </div>
              <div class="time-stat-card">
                <span class="time-label">Sessions Analyzed</span>
                <span class="time-value" id="statsLoudestDay">--</span>
                <span class="time-avg" id="statsLoudestDayAvg">--</span>
                <div class="stat-explanation explanation-hidden">
                  The number of distinct monitoring sessions detected. Sessions are identified by continuous monitoring periods with gaps of 5+ minutes between them.
                </div>
              </div>
            </div>
          </div>

          <!-- Trend Analysis Section -->
          <div class="stats-trend-analysis" id="statsTrendAnalysis">
            <h3>Trend Analysis</h3>
            <div class="trend-stats-grid">
              <div class="trend-stat">
                <span class="trend-label">Overall Trend</span>
                <span class="trend-value" id="statsTrendDirection">--</span>
                <span class="trend-change" id="statsTrendChange">--</span>
                <div class="stat-explanation explanation-hidden">
                  Shows whether noise levels are increasing, decreasing, or staying stable over the selected time period. Calculated by comparing the first half to the second half of the period.
                </div>
                <div class="volatility-formula explanation-hidden">
                  <div class="formula-container" style="flex-direction: column; align-items: flex-start; gap: 0.25rem;">
                    <span class="formula-main">% change =</span>
                    <span class="formula-main">(secondHalfAvg - firstHalfAvg)</span>
                    <span class="formula-main">/ firstHalfAvg</span>
                    <span class="formula-main">× 100</span>
                  </div>
                </div>
              </div>
              <div class="trend-stat">
                <span class="trend-label">Volatility</span>
                <span class="trend-value" id="statsVolatility">--</span>
                <span class="trend-stddev" id="statsStdDev">--</span>
                <div class="volatility-formula explanation-hidden" id="statsVolatilityFormula">
                  <div class="formula-container">
                    <span class="formula-main">σ = √</span>
                    <span class="formula-fraction">
                      <span class="formula-numerator">Σ(x - μ)²</span>
                      <span class="formula-divider"></span>
                      <span class="formula-denominator">n</span>
                    </span>
                  </div>
                  <div class="formula-variables">
                    <div class="variable-item">
                      <span class="variable-symbol">σ</span>
                      <span class="variable-label">= Standard Deviation (volatility)</span>
                    </div>
                    <div class="variable-item">
                      <span class="variable-symbol">x</span>
                      <span class="variable-label">= Each noise level measurement</span>
                    </div>
                    <div class="variable-item">
                      <span class="variable-symbol">μ</span>
                      <span class="variable-label">= Average noise level</span>
                    </div>
                    <div class="variable-item">
                      <span class="variable-symbol">n</span>
                      <span class="variable-label">= Total number of measurements</span>
                    </div>
                  </div>
                  <div class="formula-description">
                    Measures how much noise levels vary from the average. Lower values mean steadier volume, higher values mean more fluctuation.
                  </div>
                </div>
              </div>
            </div>
          </div>

          <!-- Class Ranking (Comparison) -->
          <div class="stats-comparison-container" id="statsComparisonContainer">
            <h3>Class Quietness Ranking</h3>
            <div id="statsComparisonChart" class="stats-comparison-chart">
              <div class="no-comparison-data">No comparison data available<br/><span style="font-size: 0.9rem; color: #666;">Select a class to view ranking</span></div>
            </div>
            <div class="stat-explanation explanation-hidden">
              Ranks all classes by their average quietness (lower average volume = quieter = better rank). The selected class is highlighted. Classes are sorted from quietest (rank 1) to loudest.
            </div>
          </div>

          <div class="stats-chart-container">
            <div id="statsChart" class="stats-chart"></div>
            <div id="statsNoData" class="stats-no-data">
              <p>Select a class to view statistics</p>
            </div>
          </div>

          <div class="stats-summary" id="statsSummary">
            <div class="stats-summary-item">
              <span class="stats-label">Average Level</span>
              <span class="stats-value" id="statsAvg">--</span>
              <span class="stats-unit">(0-100%)</span>
              <div class="stat-explanation explanation-hidden">
                The mean (average) noise level across all samples in the selected time range. Formula: (sum of all levels) ÷ (number of samples).
              </div>
              <div class="volatility-formula explanation-hidden">
                <div class="formula-container">
                  <span class="formula-main">μ =</span>
                  <span class="formula-fraction">
                    <span class="formula-numerator">Σx</span>
                    <span class="formula-divider"></span>
                    <span class="formula-denominator">n</span>
                  </span>
                </div>
                <div class="formula-variables">
                  <div class="variable-item">
                    <span class="variable-symbol">μ</span>
                    <span class="variable-label">= Mean (average) noise level</span>
                  </div>
                  <div class="variable-item">
                    <span class="variable-symbol">x</span>
                    <span class="variable-label">= Each noise level measurement</span>
                  </div>
                  <div class="variable-item">
                    <span class="variable-symbol">n</span>
                    <span class="variable-label">= Total number of samples</span>
                  </div>
                </div>
              </div>
            </div>
            <div class="stats-summary-item">
              <span class="stats-label">Peak Level</span>
              <span class="stats-value" id="statsPeak">--</span>
              <span class="stats-unit">(0-100%)</span>
              <div class="stat-explanation explanation-hidden">
                The highest single noise level measurement recorded during the selected time period. Shows the maximum volume reached.
              </div>
              <div class="volatility-formula explanation-hidden">
                <div class="formula-container">
                  <span class="formula-main">max = MAX(x₁, x₂, ..., xₙ)</span>
                </div>
                <div class="formula-variables">
                  <div class="variable-item">
                    <span class="variable-symbol">max</span>
                    <span class="variable-label">= Maximum noise level</span>
                  </div>
                  <div class="variable-item">
                    <span class="variable-symbol">x₁, x₂, ..., xₙ</span>
                    <span class="variable-label">= All noise level measurements</span>
                  </div>
                </div>
              </div>
            </div>
            <div class="stats-summary-item">
              <span class="stats-label">Samples</span>
              <span class="stats-value" id="statsSampleCount">--</span>
              <span class="stats-unit">(count)</span>
              <div class="stat-explanation explanation-hidden">
                The total number of noise level measurements collected during the selected time range. More samples provide more accurate statistics.
              </div>
            </div>
          </div>

          <!-- Additional Statistics Cards -->
          <div class="stats-additional" id="statsAdditional">
            <div class="stats-additional-grid">
              <div class="stats-additional-card stress-card">
                <span class="additional-label">Teacher Stress Score</span>
                <span class="additional-value" id="statsStressScore">--</span>
                <span class="additional-unit">(0-1400, based on most recent day's average volume)</span>
                <span class="additional-description" id="statsStressDescription">--</span>
                <div class="stat-explanation explanation-hidden">
                  A fun, arbitrary score that maps the most recent day's average volume to a 0-1400 scale. Formula: (average volume) × 14. Higher volume = higher stress score. Not scientifically validated, just for fun!
                </div>
                <div class="volatility-formula explanation-hidden">
                  <div class="formula-container">
                    <span class="formula-main">stress = avgVolume × 14</span>
                  </div>
                  <div class="formula-variables">
                    <div class="variable-item">
                      <span class="variable-symbol">stress</span>
                      <span class="variable-label">= Teacher Stress Score (0-1400)</span>
                    </div>
                    <div class="variable-item">
                      <span class="variable-symbol">avgVolume</span>
                      <span class="variable-label">= Average volume of most recent day (0-100%)</span>
                    </div>
                  </div>
                </div>
              </div>
              <div class="stats-additional-card">
                <span class="additional-label">Total Monitoring Time</span>
                <span class="additional-value" id="statsTotalTime">--</span>
                <span class="additional-unit">(hours:minutes)</span>
                <div class="stat-explanation explanation-hidden">
                  The total amount of time this class has been monitored, calculated from the first sample to the last sample. Shows how much data has been collected.
                </div>
              </div>
              <div class="stats-additional-card">
                <span class="additional-label">Noise Range</span>
                <span class="additional-value" id="statsNoiseRange">--</span>
                <span class="additional-unit">(min-max spread in %)</span>
                <div class="stat-explanation explanation-hidden">
                  The difference between the highest and lowest noise levels recorded. Formula: (maximum level) - (minimum level). Shows the full span of volume variation.
                </div>
                <div class="volatility-formula explanation-hidden">
                  <div class="formula-container">
                    <span class="formula-main">range = max - min</span>
                  </div>
                  <div class="formula-variables">
                    <div class="variable-item">
                      <span class="variable-symbol">range</span>
                      <span class="variable-label">= Noise range (spread)</span>
                    </div>
                    <div class="variable-item">
                      <span class="variable-symbol">max</span>
                      <span class="variable-label">= Maximum noise level</span>
                    </div>
                    <div class="variable-item">
                      <span class="variable-symbol">min</span>
                      <span class="variable-label">= Minimum noise level</span>
                    </div>
                  </div>
                </div>
              </div>
              <div class="stats-additional-card">
                <span class="additional-label">Average Session Duration</span>
                <span class="additional-value" id="statsAvgSessionDuration">--</span>
                <span class="additional-unit">(minutes)</span>
                <div class="stat-explanation explanation-hidden">
                  The average length of monitoring sessions for this class. Sessions are continuous monitoring periods (gaps of 5+ minutes create new sessions). Formula: (sum of session durations) ÷ (number of sessions).
                </div>
                <div class="volatility-formula explanation-hidden">
                  <div class="formula-container">
                    <span class="formula-main">avg =</span>
                    <span class="formula-fraction">
                      <span class="formula-numerator">Σd</span>
                      <span class="formula-divider"></span>
                      <span class="formula-denominator">n</span>
                    </span>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script src="renderer.js"></script>
</body>
</html>
